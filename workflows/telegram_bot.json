{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "517061a9-2285-477a-89d1-9d164ee35f3a",
      "name": "Telegram Trigger",
      "webhookId": "819ebd30-b728-486e-9fb9-deb277bc3271",
      "credentials": {
        "telegramApi": {
          "id": "DOYAH0PcyOnZtmHe",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ---------- INPUT ----------\nconst text = String($json?.message?.text || '').trim();\n\n// ---------- Utils ----------\nconst chatId = $json?.message?.chat?.id;\nconst parts  = text.split(/\\s+/);\nconst rawSym = (parts[0] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\nconst tfInput = (parts[1] || '').toLowerCase();\n\n// –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å–∏–º–≤–æ–ª—É: –¥–æ–±–∞–≤–∏–º USDT, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã —Ç–∏–∫–µ—Ä\nconst symbolGuess = rawSym ? `${rawSym}USDT` : '';\n\n// –ï–¥–∏–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫: –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º chatId, symbol, tf\nconst err = (message) => {\n  return [{\n    json: {\n      error: message,\n      chatId,\n      symbol: symbolGuess,    // –¥–∞–∂–µ –≤ –æ—à–∏–±–∫–µ –ø–µ—Ä–µ–¥–∞—ë–º, –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ\n      tf: tfInput             // –¥–∞–∂–µ –≤ –æ—à–∏–±–∫–µ –ø–µ—Ä–µ–¥–∞—ë–º –∏—Å—Ö–æ–¥–Ω–æ–µ, —á—Ç–æ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n    }\n  }];\n};\n\n// ---------- –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ----------\nif (!rawSym || !tfInput) {\n  return err('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: <–º–æ–Ω–µ—Ç–∞> <—Ç–∞–π–º—Ñ—Ä–µ–π–º>, –Ω–∞–ø—Ä–∏–º–µ—Ä: BTC 1H');\n}\nif (!/^[A-Z0-9]{2,12}$/.test(rawSym)) {\n  return err('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–∫–µ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã: –Ω–∞–ø—Ä–∏–º–µ—Ä, BTC 1H');\n}\n\n// ---------- –¢–∞–π–º—Ñ—Ä–µ–π–º—ã ----------\nconst tfMap = {\n  '1m': '1min',\n  '3m': '3min',\n  '5m': '5min',\n  '15m': '15min',\n  '30m': '30min',\n  '1h': '1h',\n  '4h': '4h',\n  '6h': '6h',\n  '12h': '12h',\n  '1d': '1day',\n  '1w': '1week'\n};\n\n// –ñ—ë—Å—Ç–∫–æ –∑–∞–ø—Ä–µ—â–∞–µ–º ¬´–º–µ—Å—è—Ü¬ª\nconst monthAliases = ['1mo', '1mth', '1month', '1–º–æ–Ω', '1–º–µ—Å—è—Ü', '1–º', '1M']; // —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\nif (monthAliases.includes(tfInput)) {\n  return err('–¢–∞–π–º—Ñ—Ä–µ–π–º 1M (–º–µ—Å—è—Ü) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 1day –∏–ª–∏ 1week.');\n}\n\nif (!tfMap[tfInput]) {\n  return err('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º. –î–æ—Å—Ç—É–ø–Ω–æ: 1m, 3m, 5m, 15m, 30m, 1h, 4h, 6h, 12h, 1d, 1w.');\n}\n\n// ---------- –£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ ----------\nreturn [{\n  json: {\n    chatId,\n    symbol: `${rawSym}USDT`,\n    tf: tfInput,                  // —á—Ç–æ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n    granularity: tfMap[tfInput],  // —á—Ç–æ –∂–¥—ë—Ç Bitget\n    limit: 300\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ],
      "id": "a042b7a8-0201-4da8-90ca-06bb35f52d94",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "40d63d93-1dda-4858-891a-8457838db225",
              "leftValue": "={{$json.error}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        416,
        0
      ],
      "id": "f877dd4e-beef-41f6-bdb2-0350ea7e8304",
      "name": "If"
    },
    {
      "parameters": {
        "url": "https://api.bitget.com/api/v2/spot/market/candles",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "symbol",
              "value": "={{$json.symbol}}"
            },
            {
              "name": "granularity",
              "value": "={{$json.granularity}}"
            },
            {
              "name": "limit",
              "value": "={{$json.limit}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        624,
        -96
      ],
      "id": "38c01741-e991-4118-93fa-a87fb482ca8a",
      "name": "Bitget Candles",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "/**************************************************\n * Aggregate & Indicators  (n8n Function)\n * –í—Ö–æ–¥: –æ—Ç–≤–µ—Ç Bitget Candles ($json.data = [[ts,open,high,low,close,vol], ...])\n * –í—ã—Ö–æ–¥: { chatId, symbol, tf, granularity, limit, features, sample }\n **************************************************/\n\n// ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ----------\nfunction tryItem(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return it && it.json ? it.json : {};\n  } catch (e) { return {}; }\n}\nfunction pick(...vals) {\n  for (const v of vals) if (v !== undefined && v !== null && v !== '') return v;\n  return undefined;\n}\nfunction normTf(tf) {\n  if (!tf) return undefined;\n  let t = String(tf).toLowerCase().trim();\n  t = t\n    .replace(/^1hour$/, '1h')\n    .replace(/^1week$/, '1w')\n    .replace(/^1min$/,  '1m')\n    .replace(/minute$/, 'm')\n    .replace(/min$/,    'm')\n    .replace(/hour$/,   'h')\n    .replace(/week$/,   'w');\n  return t;\n}\n\n// ---------- 0) –ü–û–î–¢–Ø–ì–ò–í–ê–ï–ú –ü–ê–†–ê–ú–ï–¢–†–´ ----------\nconst fromIf   = tryItem('If');\nconst fromCode = tryItem('Code');\nconst fromTrig = tryItem('Telegram Trigger');\n\n// –¢–æ, —á—Ç–æ –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ç –ø—Ä–µ–¥. —à–∞–≥–æ–≤ / —Ç–µ–∫—É—â–µ–≥–æ JSON\nlet symbol      = pick($json.symbol, fromIf.symbol, fromCode.symbol);\nlet tf          = pick($json.tf, $json.granularity, fromIf.tf, fromIf.granularity, fromCode.tf, fromCode.granularity);\nlet granularity = pick($json.granularity, fromIf.granularity, fromCode.granularity, tf);\nlet limit       = pick($json.limit, fromIf.limit, fromCode.limit);\nlet chatId      = pick($json.chatId, fromIf.chatId, fromCode.chatId, fromTrig?.message?.chat?.id);\n\ntf = normTf(tf);\ngranularity = normTf(granularity);\n\n// ---------- 1) –°–í–ï–ß–ò BITGET ----------\nconst raw = $json?.data || [];\nif (!Array.isArray(raw) || raw.length === 0) {\n  return [{\n    json: {\n      error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–≤–µ—á–µ (–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞).',\n      chatId, symbol: symbol || 'UNKNOWN', tf: tf || 'unknown'\n    }\n  }];\n}\n\n// –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ —á–∏—Å–ª–∞\nconst kLines = raw\n  .map(k => [\n    Number(k[0]), // ts\n    Number(k[1]), // open\n    Number(k[2]), // high\n    Number(k[3]), // low\n    Number(k[4]), // close\n    Number(k[5] ?? 0) // volume\n  ])\n  .filter(k => Number.isFinite(k[0]) && Number.isFinite(k[4]));\n\nconst times   = kLines.map(k => k[0]);\nconst opens   = kLines.map(k => k[1]);\nconst highs   = kLines.map(k => k[2]);\nconst lows    = kLines.map(k => k[3]);\nconst closes  = kLines.map(k => k[4]);\nconst volumes = kLines.map(k => k[5]);\n\n// ---------- 2) –ü–†–û–í–ï–†–ö–ê –ú–ò–ù–ò–ú–£–ú–ê –ò–°–¢–û–†–ò–ò ----------\nconst MIN_BARS = 220; // –∑–∞–ø–∞—Å –¥–ª—è EMA200/ADX\nif (kLines.length < MIN_BARS) {\n  return [{\n    json: {\n      error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω—å—à–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –∏–ª–∏ –¥—Ä—É–≥—É—é –º–æ–Ω–µ—Ç—É.',\n      chatId, symbol: symbol || 'UNKNOWN', tf: tf || 'unknown'\n    }\n  }];\n}\n\n// ---------- 3) –•–ï–õ–ü–ï–†–´ –ò –ò–ù–î–ò–ö–ê–¢–û–†–´ ----------\nconst SMA = (arr, p) => {\n  if (arr.length < p) return null;\n  const s = arr.slice(-p).reduce((a,b)=>a+b,0);\n  return s / p;\n};\n\nconst EMA_full = (arr, p) => {\n  if (arr.length < p) return null;\n  const k = 2 / (p + 1);\n  let ema = SMA(arr.slice(0, p), p);\n  for (let i = p; i < arr.length; i++) {\n    ema = arr[i] * k + ema * (1 - k);\n  }\n  return ema;\n};\n\n// —Ä—è–¥ EMA (–¥–ª—è MACD)\nconst EMA_series = (arr, p) => {\n  if (arr.length < p) return [];\n  const k = 2 / (p + 1);\n  let ema = SMA(arr.slice(0, p), p);\n  const out = [];\n  for (let i = p; i < arr.length; i++) {\n    ema = arr[i] * k + ema * (1 - k);\n    out.push(ema);\n  }\n  return out;\n};\n\nconst STD = (arr) => {\n  if (!arr || arr.length === 0) return null;\n  const m = arr.reduce((a,b)=>a+b,0) / arr.length;\n  const v = arr.reduce((a,b)=>a + (b - m) * (b - m), 0) / arr.length;\n  return Math.sqrt(v);\n};\n\n// EMA50 / EMA200\nconst ema50  = EMA_full(closes, 50);\nconst ema200 = EMA_full(closes, 200);\n\n// RSI14\nconst RSI = (arr, p = 14) => {\n  if (arr.length < p + 1) return null;\n  let gains = 0, losses = 0;\n  for (let i = arr.length - p; i < arr.length; i++) {\n    const ch = arr[i] - arr[i - 1];\n    if (ch > 0) gains += ch; else losses -= ch;\n  }\n  const avgG = gains / p;\n  const avgL = losses / p;\n  if (avgL === 0) return 100;\n  const rs = avgG / avgL;\n  return 100 - (100 / (1 + rs));\n};\nconst rsi14 = RSI(closes, 14);\n\n// ATR14\nconst ATR = (h, l, c, p = 14) => {\n  if (h.length < p + 1 || l.length < p + 1 || c.length < p + 1) return null;\n  const TR = [];\n  for (let i = 1; i < h.length; i++) {\n    const tr = Math.max(\n      h[i] - l[i],\n      Math.abs(h[i] - c[i - 1]),\n      Math.abs(l[i] - c[i - 1])\n    );\n    TR.push(tr);\n  }\n  return EMA_full(TR, p); // Wilder EMA\n};\nconst atr14 = ATR(highs, lows, closes, 14);\n\n// ADX14 (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)\nconst ADX = (h, l, c, p = 14) => {\n  if (h.length < p + 1) return null;\n  const dmPlus = [], dmMinus = [], TR = [];\n  for (let i = 1; i < h.length; i++) {\n    const up = h[i] - h[i - 1];\n    const dn = l[i - 1] - l[i];\n    dmPlus.push(up > dn && up > 0 ? up : 0);\n    dmMinus.push(dn > up && dn > 0 ? dn : 0);\n    TR.push(Math.max(\n      h[i] - l[i],\n      Math.abs(h[i] - c[i - 1]),\n      Math.abs(l[i] - c[i - 1])\n    ));\n  }\n  const tr14 = EMA_full(TR, p);\n  const dmp14 = EMA_full(dmPlus, p);\n  const dmn14 = EMA_full(dmMinus, p);\n  if ([tr14, dmp14, dmn14].some(v => v === null)) return null;\n\n  const plusDI  = 100 * (dmp14 / tr14);\n  const minusDI = 100 * (dmn14 / tr14);\n  const dx = 100 * (Math.abs(plusDI - minusDI) / Math.max(plusDI + minusDI, 1e-9));\n  return dx;\n};\nconst adx14 = ADX(highs, lows, closes, 14);\n\n// Bollinger Bands (20, 2) ‚Äî –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞\nconst BB_width = (arr, p = 20, mult = 2) => {\n  if (arr.length < p) return null;\n  const last = arr.slice(-p);\n  const m = last.reduce((a,b)=>a+b,0)/p;\n  const sd = STD(last);\n  const upper = m + mult * sd;\n  const lower = m - mult * sd;\n  if (!Number.isFinite(upper) || !Number.isFinite(lower)) return null;\n  return (upper - lower) / m;\n};\nconst bb_width = BB_width(closes, 20, 2);\n\n// –ù–∞–∫–ª–æ–Ω EMA200 (–¥–µ–ª—å—Ç–∞ –∑–∞ 5 –±–∞—Ä–æ–≤)\nlet ema200_slope = null;\nif (closes.length >= 200 + 5) {\n  const emaSeries200 = EMA_series(closes, 200);\n  if (emaSeries200.length >= 6) {\n    const last = emaSeries200.at(-1);\n    const prev = emaSeries200.at(-6);\n    ema200_slope = (last - prev) / 5;\n  }\n}\n\n// –†–µ–∂–∏–º: trend/range\nlet regime = 'range';\nif (adx14 !== null && adx14 > 20 && bb_width !== null && bb_width > 0.01) regime = 'trend';\n\n// MACD 12/26/9\nconst fast = 12, slow = 26, signalP = 9;\nconst emaFast = EMA_full(closes, fast);\nconst emaSlow = EMA_full(closes, slow);\nlet macd = null, macd_signal = null, macd_hist = null;\nif (emaFast !== null && emaSlow !== null) {\n  macd = emaFast - emaSlow;\n  const emaFser = EMA_series(closes, fast);\n  const emaSser = EMA_series(closes, slow);\n  const mLen = Math.min(emaFser.length, emaSser.length);\n  const macdSeries = [];\n  for (let i = 0; i < mLen; i++) macdSeries.push(emaFser[i] - emaSser[i]);\n  macd_signal = EMA_full(macdSeries, signalP);\n  if (macd_signal !== null) macd_hist = macd - macd_signal;\n}\n\n// Stochastic 14,3,3\nfunction stochasticK(highs, lows, closes, period = 14, smoothK = 3, smoothD = 3) {\n  if (closes.length < period + smoothK + smoothD) return { k: null, d: null };\n  const rawK = [];\n  for (let i = period - 1; i < closes.length; i++) {\n    const hi = Math.max(...highs.slice(i - period + 1, i + 1));\n    const lo = Math.min(...lows.slice(i - period + 1, i + 1));\n    const k = (hi === lo) ? 50 : ((closes[i] - lo) / (hi - lo)) * 100;\n    rawK.push(k);\n  }\n  const smK = [];\n  for (let i = 3 - 1; i < rawK.length; i++) {\n    smK.push(SMA(rawK.slice(i - 3 + 1, i + 1), 3));\n  }\n  const lastK = smK.at(-1);\n  const dArr = [];\n  for (let i = 3 - 1; i < smK.length; i++) {\n    dArr.push(SMA(smK.slice(i - 3 + 1, i + 1), 3));\n  }\n  const lastD = dArr.at(-1);\n  return { k: lastK ?? null, d: lastD ?? null };\n}\nconst { k: stoch_k, d: stoch_d } = stochasticK(highs, lows, closes, 14, 3, 3);\n\n// OBV + —Å—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º 20\nlet obv = null;\nif (closes.length > 1 && volumes.length === closes.length) {\n  let acc = 0;\n  for (let i = 1; i < closes.length; i++) {\n    if (closes[i] > closes[i-1]) acc += volumes[i];\n    else if (closes[i] < closes[i-1]) acc -= volumes[i];\n  }\n  obv = acc;\n}\nconst vol_avg20 = SMA(volumes, 20);\n\n// ---------- 4) –§–ò–ß–ò + –°–≠–ú–ü–õ ----------\nconst last_close = closes.at(-1);\nconst features = {\n  last_close,\n  ema50,\n  ema200,\n  rsi14,\n  atr14,\n  adx14,\n  bb_width,\n  ema200_slope,\n  regime,\n  macd,\n  macd_signal,\n  macd_hist,\n  stoch_k,\n  stoch_d,\n  obv,\n  vol_avg20\n};\n\n// –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–≤–µ—á–µ–π (t, o, h, l, c)\nconst sample = kLines.slice(-100).map(k => [k[0], k[1], k[2], k[3], k[4]]);\n\n// ---------- 5) –í–û–ó–í–†–ê–¢ ----------\nreturn [{\n  json: {\n    chatId,\n    symbol: symbol || 'UNKNOWN',\n    tf: tf || 'unknown',\n    granularity: granularity || tf || 'unknown',\n    limit,\n    features,\n    sample\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -208
      ],
      "id": "06239898-8b43-4b33-b202-4388d8bd855f",
      "name": "Aggregate & Indicators"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64af54a9-2904-4501-baa3-7d0469bf25a5",
              "leftValue": "={{$json.error}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1104,
        -208
      ],
      "id": "9765c0d4-c5b7-436b-b1d7-0aa64292d353",
      "name": "if2"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "=‚ÑπÔ∏è <b>–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</b>  \n<code>–º–æ–Ω–µ—Ç–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º</code>\n\n<b>–ü—Ä–∏–º–µ—Ä—ã:</b>  \n‚Ä¢ BTC 1h  \n‚Ä¢ ETH 4h  \n‚Ä¢ SOL 15m  \n‚Ä¢ LINEA 1w\n",
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        624,
        96
      ],
      "id": "6d1bd1e9-91d0-4537-a53f-85a16e4c4a51",
      "name": "–Ω–µ –≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
      "webhookId": "b4108525-b1c6-4217-85d2-a8b91bd335ad",
      "credentials": {
        "telegramApi": {
          "id": "DOYAH0PcyOnZtmHe",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=‚ö†Ô∏è <b>–í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–Ω–µ—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</b>\n\n<b>–ú–æ–Ω–µ—Ç–∞:</b> {{ $json.symbol }}\n\n<b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:</b>\n‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–Ω–µ—Ç—É\n",
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        880,
        -32
      ],
      "id": "ea60eaf7-625d-4f5b-8465-afb05df5a58c",
      "name": "–µ—Å–ª–∏ –º–æ–Ω–µ—Ç—ã –Ω–µ—Ç",
      "webhookId": "0e418eea-8a0a-4163-aada-6c5227e2350c",
      "credentials": {
        "telegramApi": {
          "id": "DOYAH0PcyOnZtmHe",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=‚ö†Ô∏è <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</b>\n\n<b>–ú–æ–Ω–µ—Ç–∞:</b> <code>{{$json.symbol}}</code>\n<b>–¢–∞–π–º—Ñ—Ä–µ–π–º:</b> <code>{{$json.tf}}</code>\n\n<b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:</b>\n‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω—å—à–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15m –∏–ª–∏ 1h)\n‚Ä¢ –ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–Ω–µ—Ç—É —Å –±–æ–ª—å—à–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π —Ç–æ—Ä–≥–æ–≤",
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1344,
        -32
      ],
      "id": "f8591c05-90f1-47c4-9c25-4be78634ca75",
      "name": "–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –º–æ–Ω–µ—Ç–µ",
      "webhookId": "c9515cb2-2a28-455c-8725-1099b6fdf715",
      "credentials": {
        "telegramApi": {
          "id": "DOYAH0PcyOnZtmHe",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**********************************************\n * Build LLM Prompt  (n8n Function)\n * –í—Ö–æ–¥ (–∏–∑ Aggregate & Indicators):\n *   { chatId, symbol, tf, granularity, limit, features, sample }\n * –í—ã—Ö–æ–¥:\n *   { prompt: [ {role, content}, ... ], symbol, tf, granularity }\n **********************************************/\n\n// 1) –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst {\n  features = {},\n  sample = [],\n  symbol = null,\n  tf: _tf = null,\n  granularity: _gran = null,\n} = $json;\n\n// –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ tf –Ω–µ –ø—É—Å—Ç–æ–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º granularity –∫–∞–∫ –¥—É–±–ª—å)\nconst tf = _tf || _gran || null;\nconst granularity = _gran || _tf || null;\n\n// 2) –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nconst round = (v, p = 6) => {\n  if (v === null || v === undefined || Number.isNaN(Number(v))) return null;\n  const f = Math.pow(10, p);\n  return Math.round(Number(v) * f) / f;\n};\n\nconst cloneRounded = (obj) => {\n  const out = {};\n  for (const k of Object.keys(obj || {})) {\n    const v = obj[k];\n    out[k] = (typeof v === 'number') ? round(v, 6) : v;\n  }\n  return out;\n};\n\n// 3) –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst f = cloneRounded(features);\n\n// —É–º–µ–Ω—å—à–∏–º —Ä–∞–∑–º–µ—Ä sample (—Ö–≤–∞—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥. 60 —Å–≤–µ—á–µ–π)\nconst sampleCompact = (Array.isArray(sample) ? sample : []).slice(-60);\n\n// 4) –°–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (—á—Ç–æ –∏ –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å)\nconst systemMessage = `\n–¢—ã ‚Äî –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫—Ä–∏–ø—Ç–æ—Ä—ã–Ω–∫–∞.\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ —Ç–æ—Ä–≥–æ–≤–æ–º —Å–∏–≥–Ω–∞–ª–µ –°–ï–ô–ß–ê–°, —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.\n\n–ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n1) –í–æ–∑–≤—Ä–∞—â–∞–π –°–¢–†–û–ì–û –æ–¥–∏–Ω JSON-–æ–±—ä–µ–∫—Ç –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ—è—Å–Ω—è—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n2) JSON-—Å—Ö–µ–º–∞:\n{\n  \"decision\": \"long\" | \"short\" | \"none\",\n  \"entry\": number | null,                // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–±–ª–∏–∂–∞–π—à–∞—è –∫ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ) –∏–ª–∏ null\n  \"targets\": number[],                   // –º–∞—Å—Å–∏–≤ –∏–∑ 2‚Äì4 —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–æ–≤ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é\n  \"stop\": number | null,                 // —Å—Ç–æ–ø-–ª–æ—Å—Å –∏–ª–∏ null\n  \"confidence\": number,                  // 0..100 ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ—à–µ–Ω–∏–∏\n  \"rationale\": string,                   // –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (<= 200 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ markdown)\n  \"basis\": string[]                      // –∫–∞–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ–≤–ª–∏—è–ª–∏ (–∫–ª—é—á–∏: \"ema50>ema200\",\"ema50<ema200\",\"ema200_slope_up\",\n                                         // \"ema200_slope_down\",\"adx_strong\",\"rsi_overbought\",\"rsi_oversold\",\"macd_cross_up\",\n                                         // \"macd_cross_down\",\"stoch_up\",\"stoch_down\",\"vol_increase\",\"range_mode\",\"trend_mode\" –∏ —Ç.–ø.)\n}\n\n–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è:\n- –ï—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –º–∞–ª–æ (ADX –Ω–∏–∑–∫–∏–π –∏/–∏–ª–∏ —à–∏—Ä–∏–Ω–∞ –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞ —É–∑–∫–∞—è, –Ω–µ—Ç —è–≤–Ω—ã—Ö –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π MACD/–°—Ç–æ—Ö–∞—Å—Ç–∏–∫–∞) ‚Üí \"decision\":\"none\".\n- –ï—Å–ª–∏ \"decision\" –Ω–µ \"none\", \"confidence\" –æ–±—ã—á–Ω–æ ‚â• 60. –°–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä–≥–µ–Ω—Ü–∏—è (—Ç—Ä–µ–Ω–¥ + –∏–º–ø—É–ª—å—Å + –æ–±—ä—ë–º) ‚Üí 70‚Äì85+.\n- –í —Ä–µ–∂–∏–º–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (range) –¥–æ–ø—É—Å–∫–∞–π —Å–∏–≥–Ω–∞–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–π —Ä–∞–∑–≤–æ—Ä–æ—Ç–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–µ (–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è).\n- –í —Ç—Ä–µ–Ω–¥–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (trend) –æ—Ç–¥–∞–≤–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Å–¥–µ–ª–∫–∞–º –ø–æ —Ç—Ä–µ–Ω–¥—É.\n- –°—Ç–æ–ø-–ª–æ—Å—Å –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã —Å –æ–ø–æ—Ä–æ–π –Ω–∞ ATR14 (—Ç–∏–ø–∏—á–Ω–æ 1.0‚Äì1.8 * ATR): –¥–ª—è long ‚Äî –Ω–∏–∂–µ, –¥–ª—è short ‚Äî –≤—ã—à–µ; —Ü–µ–ª–∏ –ø–æ R-–º–Ω–æ–∂–∏—Ç–µ–ª—è–º (0.5R / 1R / 1.5R / 2R) –ª–∏–±–æ –ø–æ –±–ª–∏–∂–∞–π—à–∏–º —É—Ä–æ–≤–Ω—è–º.\n- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã.\n- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–π \"none\".\n\n–°—Ç–∏–ª—å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –∏ –∫—Ä–∞—Ç–∫–∏–µ –º–µ—Ç–∫–∏. –ù–∏–∫–∞–∫–∏—Ö –ª–∏—à–Ω–∏—Ö –ø–æ–ª–µ–π –ø–æ–º–∏–º–æ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ —Å—Ö–µ–º–µ.\n`;\n\n// 5) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏\nconst userPayload = {\n  meta: {\n    symbol: symbol || null,\n    timeframe: tf || null,\n  },\n  data: {\n    // —Ç–µ–∫—É—â–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏\n    features: f,\n    // –Ω–µ–±–æ–ª—å—à–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–≤–µ—á–µ–π [t, o, h, l, c]\n    sample: sampleCompact\n  }\n};\n\n// 6) –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è OpenAI node\nconst prompt = [\n  { role: 'system', content: systemMessage.trim() },\n  { role: 'user',   content: JSON.stringify(userPayload) }\n];\n\n// 7) –í–æ–∑–≤—Ä–∞—â–∞–µ–º\nreturn [{\n  json: {\n    prompt,\n    // –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–æ–¥ (Format Reply / Telegram)\n    symbol,\n    tf,\n    granularity\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        -208
      ],
      "id": "6df7b022-c756-4acd-8ff2-b53adc9df1cd",
      "name": "Build LLM Prompt"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "={{ JSON.stringify($json.prompt) }}\n"
            }
          ]
        },
        "options": {
          "maxTokens": 300,
          "temperature": 0.2,
          "topP": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1552,
        -208
      ],
      "id": "d02083d9-a551-4154-9f69-0b81ce51c00f",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "RVKZBhIZSo5FxkcD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM JSON ‚Äî –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏, –ø–∞—Ä—Å–∏–º, –≤–∞–ª–∏–¥–∏—Ä—É–µ–º.\n// –í–ê–ñ–ù–û: –µ—Å–ª–∏ —Ç–≤–æ—è –Ω–æ–¥–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ \"Build LLM Prompt\",\n// –∑–∞–º–µ–Ω–∏ –∏–º—è –≤ —Å—Ç—Ä–æ–∫–µ –Ω–∏–∂–µ.\nconst fromPrompt = ($items('Build LLM Prompt', 0, 0) || {}).json || {};\nconst fallbackChatId = fromPrompt.chatId ?? null;\nconst fallbackSymbol = fromPrompt.symbol ?? 'UNKNOWN';\nconst fallbackTf     = fromPrompt.tf     ?? 'UNKNOWN';\n\n// 1) –î–æ—Å—Ç–∞—ë–º —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –∏–∑ OpenAI-–Ω–æ–¥—ã (—É—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ö–µ–º—ã)\nfunction pickRaw(llmJson) {\n  if (!llmJson) return null;\n\n  // –°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ (Chat Completions)\n  let raw = llmJson?.choices?.[0]?.message?.content;\n  if (raw) return raw;\n\n  // –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (OpenAI Actions v2 ‚Üí \"Message a model\", Simplify Output=ON)\n  // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\n  raw = llmJson?.response?.[0]?.content?.[0]?.text;\n  if (raw) return raw;\n\n  raw = llmJson?.data;         // –∏–Ω–æ–≥–¥–∞ –∫–ª–∞–¥—É—Ç —Å—Ç—Ä–æ–∫—É —Å—é–¥–∞\n  if (raw) return raw;\n\n  raw = llmJson?.content;      // –∏–ª–∏ —Å—é–¥–∞\n  if (raw) return raw;\n\n  raw = llmJson?.text;         // –∏–ª–∏ –ø—Ä—è–º–æ text\n  if (raw) return raw;\n\n  // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º stringify –≤—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n  try { return JSON.stringify(llmJson); } catch {}\n  return null;\n}\n\nconst rawIn = pickRaw($json) ?? '';\nlet cleaned = String(rawIn).trim();\n\n// 2) –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ code fences ```json ... ```\ncleaned = cleaned.replace(/^```json/i, '').replace(/^```/, '').replace(/```$/, '').trim();\n\n// 3) –ü–∞—Ä—Å–∏–º JSON\nlet obj = null, parseError = null;\ntry {\n  obj = JSON.parse(cleaned);\n} catch (e) {\n  parseError = String(e?.message || e);\n  obj = {};\n}\n\n// 4) –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–µ—Ñ–æ–ª—Ç—ã\nconst allowedSides = new Set(['long', 'short', 'wait']);\n\nfunction clampInt(n, a, b) {\n  const x = Number(n);\n  if (!Number.isFinite(x)) return a;\n  return Math.max(a, Math.min(b, Math.round(x)));\n}\n\nconst side       = allowedSides.has(obj.side) ? obj.side : 'wait';\nconst confidence = clampInt(obj.confidence, 0, 100);\nconst rationale  = (obj.rationale != null ? String(obj.rationale) : '');\nconst basisRaw   = Array.isArray(obj.basis) ? obj.basis : [];\nconst basis      = basisRaw.map(x => String(x)).slice(0, 8);\n\nconst symbol = obj.symbol ? String(obj.symbol) : fallbackSymbol;\nconst tf     = obj.timeframe ? String(obj.timeframe) : fallbackTf;\n\n// 5) –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º –µ–¥–∏–Ω—ã–π, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –≤—ã—Ö–æ–¥\nconst out = {\n  chatId: fallbackChatId,\n  symbol,\n  timeframe: tf,\n  side,\n  confidence,\n  rationale,\n  basis,\n  _raw: cleaned,\n  _parseError: parseError || null\n};\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        -208
      ],
      "id": "eb393d8b-41ea-4686-91ae-dfea73e3872c",
      "name": "Parse LLM JSON"
    },
    {
      "parameters": {
        "jsCode": "// ---------- Helpers ----------\nfunction pick(...vals) {\n  for (const v of vals) {\n    if (v !== undefined && v !== null && v !== '') return v;\n  }\n  return undefined;\n}\n\nfunction escapeHtml(s) {\n  if (s == null) return '';\n  return String(s)\n    .replace(/&/g, '&amp;')\n    .replace(/</g,  '&lt;')\n    .replace(/>/g,  '&gt;');\n}\n\nfunction nf(x, d = 5) {\n  if (x == null || Number.isNaN(Number(x))) return '‚Äî';\n  return Number(x).toFixed(d).replace(/\\.?0+$/, ''); // –æ–±—Ä–µ–∑–∞–µ–º —Ö–≤–æ—Å—Ç—ã –Ω—É–ª–µ–π\n}\n\nfunction pct(x) {\n  if (x == null) return '‚Äî';\n  const n = Math.max(0, Math.min(100, Number(x)));\n  return `${Math.round(n)}%`;\n}\n\nfunction normalizeTf(tf) {\n  if (!tf) return 'UNKNOWN';\n  let t = String(tf).toLowerCase().trim();\n  // —á–∞—Å—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç –∞–ø–∏—à–µ–∫\n  t = t.replace(/^1hour$/, '1h')\n       .replace(/^1week$/, '1w')\n       .replace(/^1min$/, '1m')\n       .replace(/week$/, 'w')\n       .replace(/hour$/, 'h')\n       .replace(/minute$/, 'm')\n       .replace(/min$/, 'm');\n  return t;\n}\n\n// ---------- 1) –î–æ—Å—Ç–∞—ë–º –º–æ–¥–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ----------\nconst side       = String(($json.side || 'wait')).toLowerCase();     // long | short | wait\nconst confidence = Number($json.confidence ?? 0);\nconst rationale  = String($json.rationale ?? '');\nconst basis      = Array.isArray($json.basis) ? $json.basis : [];\n\nconst entry       = $json.entry ?? null;               // —á–∏—Å–ª–æ / null\nconst takeProfits = Array.isArray($json.take_profits) ? $json.take_profits : [];\nconst stopLoss    = $json.stop_loss ?? null;\n\n// ---------- 2) –î–æ—Ç—è–≥–∏–≤–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–æ–¥ ----------\n// –ü–æ–¥–≥–æ–Ω–∏ –ò–ú–ï–ù–ê –ø–æ–¥ —Ç–≤–æ–∏, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –≤ —Å—Ö–µ–º–µ\nconst jIf2  = ($items('if2', 0, 0)                    || {}).json || {};\nconst jCode = ($items('Code', 0, 0)                   || {}).json || {};\nconst jAgg  = ($items('Aggregate & Indicators', 0, 0) || {}).json || {};\nconst jTrig = ($items('Telegram Trigger', 0, 0)       || {}).json || {};\n\nlet symbol = pick($json.symbol, jIf2.symbol, jCode.symbol, jAgg.symbol);\nlet tf     = pick($json.timeframe, $json.tf, jIf2.tf, jCode.tf, jAgg.tf, jIf2.granularity, jCode.granularity);\nlet chatId = pick($json.chatId, jIf2.chatId, jCode.chatId, jTrig.message?.chat?.id);\n\nsymbol = symbol || 'UNKNOWN';\ntf     = normalizeTf(tf) || 'UNKNOWN';\n\n// ---------- 3) –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è Telegram (HTML) ----------\nconst badgeWait  = '‚ö†Ô∏è';\nconst badgeLong  = 'üü¢';\nconst badgeShort = 'üî¥';\n\nconst hSymbol = escapeHtml(symbol);\nconst hTf     = escapeHtml(tf);\nconst hRat    = escapeHtml(rationale);\nconst hBasis  = basis.length ? escapeHtml(basis.join(', ')) : '‚Äî';\n\nfunction blockLevels() {\n  const lines = [];\n  if (entry != null)        lines.push(`‚Ä¢ <b>–í—Ö–æ–¥:</b> ${nf(entry)}`);\n  if (takeProfits.length)   lines.push(`‚Ä¢ <b>–¢–µ–π–∫–∏:</b> ${takeProfits.map(x => nf(x)).join(' ‚Üí ')}`);\n  if (stopLoss != null)     lines.push(`‚Ä¢ <b>–°—Ç–æ–ø:</b> ${nf(stopLoss)}`);\n  return lines.join('\\n');\n}\n\nlet title = '';\nlet body  = '';\nlet footer = `\\n\\n<i>This message was sent automatically with n8n</i>`;\n\nif (side === 'long' || side === 'short') {\n  const badge = side === 'long' ? badgeLong : badgeShort;\n  const sideRu = side === 'long' ? '–õ–û–ù–ì' : '–®–û–†–¢';\n\n  title = `${badge} <b>–°–∏–≥–Ω–∞–ª: ${sideRu}</b>`;\n  body  = [\n    `<b>–ú–æ–Ω–µ—Ç–∞:</b> ${hSymbol}`,\n    `<b>–¢–∞–π–º—Ñ—Ä–µ–π–º:</b> ${hTf}`,\n    '',\n    blockLevels(),\n    '',\n    `<b>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</b> ${pct(confidence)}`,\n    `<b>–ü—Ä–∏—á–∏–Ω–∞:</b> ${hRat}`,\n    `<b>–ü—Ä–∏–∑–Ω–∞–∫–∏:</b> ${hBasis}`,\n  ].join('\\n');\n\n} else {\n  // wait / no signal\n  title = `${badgeWait} <b>–°–∏–≥–Ω–∞–ª –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω</b>`;\n  body  = [\n    `<b>–ú–æ–Ω–µ—Ç–∞:</b> ${hSymbol}`,\n    `<b>–¢–∞–π–º—Ñ—Ä–µ–π–º:</b> ${hTf}`,\n    '',\n    `<b>–ü—Ä–∏—á–∏–Ω–∞:</b> ${hRat || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω–≤–µ—Ä–≥–µ–Ω—Ç–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.'}`,\n    `<b>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</b> ${pct(confidence)}`,\n    '',\n    `–ü–æ–¥–æ–∂–¥—ë–º –±–æ–ª–µ–µ —á—ë—Ç–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞.`,\n  ].join('\\n');\n}\n\nconst text = `${title}\\n\\n${body}${footer}`;\n\n// ---------- 4) –û—Ç–¥–∞—ë–º –≤—Å—ë –¥–∞–ª—å—à–µ ----------\nreturn [\n  {\n    json: {\n      // –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è\n      chatId,\n      text,               // HTML-—Ç–µ–∫—Å—Ç –≤ Telegram \"Send a text message\" (Parse Mode = HTML)\n\n      // —Å–µ—Ä–≤–∏—Å –¥–ª—è –ª–æ–≥–∏–∫–∏ –¥–∞–ª—å—à–µ\n      symbol,\n      tf,\n      side,\n      confidence,\n      entry,\n      take_profits: takeProfits,\n      stop_loss: stopLoss,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        -208
      ],
      "id": "538738af-d59f-4984-ab60-d51ba1ca110c",
      "name": "Format Reply"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{$json.text}}",
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2320,
        -208
      ],
      "id": "49d8ac03-0695-4db9-8334-426a2d8c44aa",
      "name": "Send a text message",
      "webhookId": "4809bca9-a739-4260-9dfa-ec9e9d2cfad6",
      "credentials": {
        "telegramApi": {
          "id": "DOYAH0PcyOnZtmHe",
          "name": "Telegram account 2"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Bitget Candles",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–Ω–µ –≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bitget Candles": {
      "main": [
        [
          {
            "node": "Aggregate & Indicators",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–µ—Å–ª–∏ –º–æ–Ω–µ—Ç—ã –Ω–µ—Ç",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate & Indicators": {
      "main": [
        [
          {
            "node": "if2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if2": {
      "main": [
        [
          {
            "node": "Build LLM Prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –º–æ–Ω–µ—Ç–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build LLM Prompt": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Parse LLM JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse LLM JSON": {
      "main": [
        [
          {
            "node": "Format Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Reply": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "64d2e802-5ef8-4013-b1fe-8881680ff766",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c65ba4e5d3228fa4d8a07fb4174629e080dd2f0cb93a504b18dd23a45c8bd399"
  },
  "id": "YZ3HE0uQBQH2insZ",
  "tags": []
}